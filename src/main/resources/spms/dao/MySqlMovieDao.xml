<?xml version="1.0" encoding="UTF-8"?>
<!-- 2. 동적 SQL 적용 -->
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="spms.dao.MovieDao">
	<resultMap type="movie" id="movieResultMap">
		<id column="MOVIE_INDEX" property="index" />
		<result column="MOVIE_TITLE" property="title" />
		<result column="MOVIE_DIRECTOR" property="director" />
		<result column="MOVIE_ACTOR" property="actor" />
		<result column="MOVIE_GENRE" property="genre"/>
		<result column="MOVIE_LIMIT_AGE" property="limitAge"/>
		<result column="MOVIE_RUNNING_TIME" property="runningTime"/>
		<result column="MOVIE_OPEN_DATE" property="openDate"/>
		<result column="MOVIE_END_DATE" property="endDate"/>
		<result column="MOVIE_POSTER" property="poster"/>
		<result column="MOVIE_INFO" property="info"/>
		<result column="MOVIE_TAGS" property="tags"/>
		<result column="MOVIE_STATE" property="state"/>
		<result column="MOVIE_LIKE" property="like"/>
		<result column="MOVIE_RATING" property="rating"/>
	</resultMap>

	<select id="selectList" parameterType="map"
		resultMap="movieResultMap">
		SELECT MOVIE_INDEX,MOVIE_TITLE,MOVIE_DIRECTOR,MOVIE_ACTOR,MOVIE_GENRE,MOVIE_LIMIT_AGE,MOVIE_RUNNING_TIME,MOVIE_OPEN_DATE,MOVIE_END_DATE,MOVIE_POSTER,MOVIE_INFO,MOVIE_TAGS,MOVIE_STATE
		,(SELECT COUNT(*) FROM MOVIE_LIKE B WHERE B.MOVIE_INDEX = A.MOVIE_INDEX) AS 'MOVIE_LIKE',(SELECT ROUND(IFNULL(AVG(REVIEW_RATING),0),2) FROM MOVIE_REVIEW C WHERE C.MOVIE_INDEX = A.MOVIE_INDEX ) AS 'MOVIE_RATING'
		FROM MOVIE A
		<choose>
			<when test="view == 'all'">ORDER BY MOVIE_INDEX DESC</when>
			<when test="view == 'comingsoon'">WHERE MOVIE_STATE = 1 AND MOVIE_OPEN_DATE > NOW()</when>
			<otherwise>WHERE MOVIE_STATE = 1 AND MOVIE_OPEN_DATE <![CDATA[<=]]> NOW()</otherwise>
		</choose>

	</select>
	
	<insert id="insert" parameterType="movie">
		INSERT INTO MOVIE (MOVIE_TITLE,MOVIE_DIRECTOR,MOVIE_ACTOR,MOVIE_GENRE,MOVIE_LIMIT_AGE,MOVIE_RUNNING_TIME,MOVIE_OPEN_DATE,MOVIE_END_DATE,MOVIE_POSTER,MOVIE_INFO,MOVIE_TAGS,MOVIE_STATE)
		VALUES(#{title},#{director},#{actor},#{genre},#{limitAge},#{runningTime},#{openDate},#{endDate},#{poster},#{info},#{tags},1)
	</insert>
	
	<select id="selectOne" parameterType="int"
		resultMap="movieResultMap">
		SELECT MOVIE_INDEX,MOVIE_TITLE,MOVIE_DIRECTOR,MOVIE_ACTOR,MOVIE_GENRE,MOVIE_LIMIT_AGE,MOVIE_RUNNING_TIME,MOVIE_OPEN_DATE,MOVIE_END_DATE,MOVIE_POSTER,MOVIE_INFO,MOVIE_TAGS,MOVIE_STATE
		FROM MOVIE
		WHERE MOVIE_INDEX=#{value}
	</select>
	
	<update id="update" parameterType="map">
		UPDATE MOVIE
		<set>
			<if test="title != null">MOVIE_TITLE=#{title},</if>
			<if test="director != null">MOVIE_DIRECTOR=#{director},</if>
			<if test="actor != null">MOVIE_ACTOR=#{actor},</if>
			<if test="genre != null">MOVIE_GENRE=#{genre},</if>
			<if test="limitAge != null">MOVIE_LIMIT_AGE=#{limitAge},</if>
			<if test="runningTime != null">MOVIE_RUNNING_TIME=#{runningTime},</if>
			<if test="openDate != null">MOVIE_OPEN_DATE=#{openDate},</if>
			<if test="endDate != null">MOVIE_END_DATE=#{endDate},</if>
			<if test="poster != null">MOVIE_POSTER=#{poster},</if>
			<if test="info != null">MOVIE_INFO=#{info},</if>
			<if test="tags != null">MOVIE_TAGS=#{tags},</if>
			<if test="state != null">MOVIE_STATE=#{state},</if>
		</set>
		WHERE MOVIE_INDEX=#{index}
	</update>
</mapper>